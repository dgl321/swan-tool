{% extends "base.html" %}

{% block title %}Configure SWAN Parameters - SWAN Parameter Generator{% endblock %}

{% block content %}
<style>
    .form-control[readonly] {
        background-color: #f8f9fa !important;
        color: #6c757d !important;
        cursor: not-allowed;
        opacity: 0.8;
    }

    .form-control[readonly]:focus {
        box-shadow: none !important;
        border-color: #dee2e6 !important;
    }

    .auto-populated {
        position: relative;
    }

    .auto-populated::after {
        content: "Auto-populated";
        position: absolute;
        top: -8px;
        right: 8px;
        background: #6c757d;
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: 500;
    }

    .parameter-combination {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .parameter-combination:hover {
        background: #e9ecef;
    }

    .combination-preview {
        font-family: monospace;
        font-size: 0.875rem;
        color: #495057;
    }

    .combination-count {
        background: #007bff;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
</style>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Configure SWAN Parameters
                </h4>
            </div>
            <div class="card-body">
                <form action="{{ url_for('generate_files') }}" method="post" id="parameterForm">
                    <!-- Project Information -->
                    <div class="mb-4">
                        <h5 class="fw-bold text-primary mb-3">
                            <i class="fas fa-info-circle me-2"></i>Project Information
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="num_applications" class="form-label">Number of Applications</label>
                                <input type="number" class="form-control" id="num_applications" name="num_applications"
                                    value="1" min="1" max="8" required>
                            </div>
                            <div class="col-md-6">
                                <label for="output_project_path" class="form-label">Output Project Path</label>
                                <input type="text" class="form-control" id="output_project_path"
                                    name="output_project_path" value="C:\SwashProjects\Output" required>
                            </div>
                        </div>
                    </div>

                    <!-- Substance Properties -->
                    <div class="mb-4">
                        <h5 class="fw-bold text-primary mb-3">
                            <i class="fas fa-flask me-2"></i>Substance Properties
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="vapour_pressure" class="form-label">Vapour Pressure (Pa)</label>
                                <input type="number" class="form-control" id="vapour_pressure" name="vapour_pressure"
                                    value="{{ '%.2e'|format(projects[0].vapour_pressure) if projects and projects[0].vapour_pressure else '4.60e-08' }}"
                                    step="0.000000001" required>
                                {% if projects and projects[0].vapour_pressure %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Extracted from TXW files ({{ '%.2e'|format(projects[0].vapour_pressure) }} Pa)
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="mitigation_count" class="form-label">Mitigation Count</label>
                                <input type="number" class="form-control" id="mitigation_count" name="mitigation_count"
                                    value="{{ projects[0].scenarios|length if projects else 1 }}" min="1" max="20"
                                    readonly>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Automatically set to match the number of scenarios ({{ projects[0].scenarios|length
                                    if projects else 1 }})
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Multi-Parameter Selection -->
                    <div class="mb-4">
                        <h5 class="fw-bold text-primary mb-3">
                            <i class="fas fa-layer-group me-2"></i>Multi-Parameter Selection
                        </h5>
                        <div class="alert alert-info mb-3">
                            <h6 class="fw-bold mb-2">Generate Multiple Parameter Combinations</h6>
                            <p class="mb-0 small">Select multiple values for each parameter to generate separate
                                projects for each combination.
                                For example, selecting 70% nozzle and both 10m and 20m runoff will create 2 projects:
                                "EXAMPLE_70N_10L&M" and "EXAMPLE_70N_20L&M".</p>
                        </div>

                        <!-- Nozzle Reduction Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Nozzle Reduction (%)</label>
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input nozzle-checkbox" type="checkbox" id="nozzle_0"
                                            value="0">
                                        <label class="form-check-label" for="nozzle_0">0% (No reduction)</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input nozzle-checkbox" type="checkbox" id="nozzle_50"
                                            value="50">
                                        <label class="form-check-label" for="nozzle_50">50%</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input nozzle-checkbox" type="checkbox" id="nozzle_70"
                                            value="70">
                                        <label class="form-check-label" for="nozzle_70">70%</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input nozzle-checkbox" type="checkbox" id="nozzle_90"
                                            value="90">
                                        <label class="form-check-label" for="nozzle_90">90%</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Runoff Mitigation Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Runoff Mitigation Scenarios</label>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input runoff-checkbox" type="checkbox" id="runoff_10m"
                                            value="10m">
                                        <label class="form-check-label" for="runoff_10m">
                                            10m VFS Buffer (Volume: 0.6, Erosion: 0.85)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input runoff-checkbox" type="checkbox" id="runoff_20m"
                                            value="20m">
                                        <label class="form-check-label" for="runoff_20m">
                                            20m VFS Buffer (Volume: 0.8, Erosion: 0.95)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Buffer Width Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Buffer Width (m)</label>
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input buffer-checkbox" type="checkbox" id="buffer_0"
                                            value="0">
                                        <label class="form-check-label" for="buffer_0">0m (No buffer)</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input buffer-checkbox" type="checkbox" id="buffer_5"
                                            value="5">
                                        <label class="form-check-label" for="buffer_5">5m</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input buffer-checkbox" type="checkbox" id="buffer_10"
                                            value="10">
                                        <label class="form-check-label" for="buffer_10">10m</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input buffer-checkbox" type="checkbox" id="buffer_20"
                                            value="20">
                                        <label class="form-check-label" for="buffer_20">20m</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Parameter Combinations Preview -->
                        <div class="mb-4">
                            <h6 class="fw-bold text-secondary mb-3">
                                <i class="fas fa-eye me-2"></i>Parameter Combinations Preview
                                <span class="combination-count ms-2" id="combinationCount">0</span>
                            </h6>
                            <div id="combinationsPreview" class="border rounded p-3 bg-light">
                                <p class="text-muted mb-0">Select parameters above to see the combinations that will be
                                    generated...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Legacy Single Parameter Fields (Hidden) -->
                    <div style="display: none;">
                        <input type="hidden" id="nozzle_reduction" name="nozzle_reduction" value="0">
                        <input type="hidden" id="mitigation_scenario" name="mitigation_scenario" value="">
                        <input type="hidden" id="buffer_width" name="buffer_width" value="0">
                        <input type="hidden" id="runoff_volume_reduction" name="runoff_volume_reduction" value="0.0">
                        <input type="hidden" id="runoff_flux_reduction" name="runoff_flux_reduction" value="0.0">
                        <input type="hidden" id="erosion_mass_reduction" name="erosion_mass_reduction" value="0.0">
                        <input type="hidden" id="erosion_flux_reduction" name="erosion_flux_reduction" value="0.0">
                    </div>

                    <!-- Spray Drift Mitigation -->
                    <div class="mb-4">
                        <h5 class="fw-bold text-primary mb-3">
                            <i class="fas fa-wind me-2"></i>Additional Options
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="use_step3_mass_loadings"
                                        name="use_step3_mass_loadings">
                                    <label class="form-check-label" for="use_step3_mass_loadings">
                                        Use Step 3 Mass Loadings
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="select_buffer_width"
                                        name="select_buffer_width">
                                    <label class="form-check-label" for="select_buffer_width">
                                        Select Buffer Width
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-magic me-2"></i>Generate SWAN Files
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Project Summary -->
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>Processed Projects ({{ projects|length }})
                </h6>
            </div>
            <div class="card-body">
                {% for project in projects %}
                <div class="border-bottom pb-3 mb-3">
                    <h6 class="text-primary fw-bold">{{ project.project_name }}</h6>
                    <div class="small">
                        <div class="mb-1"><strong>Substance:</strong> {{ project.substance_name or 'Unknown' }}</div>
                        <div class="mb-1"><strong>Crop:</strong> {{ project.crop or 'Unknown' }}</div>
                        <div class="mb-1"><strong>Scenarios:</strong> {{ project.scenarios|length }}</div>
                        <div class="mb-1"><strong>Mitigation Count:</strong> {{ project.scenarios|length }}</div>
                        {% if project.vapour_pressure %}
                        <div class="mb-1"><strong>Vapour Pressure:</strong> {{ '%.2e'|format(project.vapour_pressure) }}
                            Pa</div>
                        {% endif %}
                        <div class="mb-2"><strong>TXW Files:</strong> {{ project.total_txw_files }} files processed
                        </div>
                        {% if project.txw_files %}
                        <div class="mt-2">
                            <strong>Sample TXW Files:</strong>
                            <ul class="small mb-0 mt-1">
                                {% for txw_file in project.txw_files[:3] %}
                                <li>{{ txw_file.filename or 'Unknown' }}</li>
                                {% endfor %}
                                {% if project.txw_files|length > 3 %}
                                <li><em>... and {{ project.txw_files|length - 3 }} more</em></li>
                                {% endif %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Template Information -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-file-code me-2"></i>Template Information
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2"><strong>Template:</strong> BIXSC45_1AP_10mS_10m_VFS.tpf</div>
                    <div class="mb-2"><strong>Run-off Mode:</strong> ManualReduction (FOCUS-compliant)</div>
                    <div class="mb-2"><strong>FOCUS Scenarios:</strong></div>
                    <ul class="small mb-3">
                        <li><strong>10m VFS Buffer:</strong> Volume 0.6, Erosion 0.85</li>
                        <li><strong>20m VFS Buffer:</strong> Volume 0.8, Erosion 0.95</li>
                    </ul>
                    <div class="mb-2"><strong>Key Placeholders:</strong></div>
                    <ul class="small mb-0">
                        <li><code>&lt;rCrop&gt;</code> - Crop name</li>
                        <li><code>&lt;rCompund&gt;</code> - Substance name</li>
                        <li><code>&lt;nApps&gt;</code> - Number of applications</li>
                        <li><code>&lt;ROVolRed&gt;</code> - Runoff volume reduction</li>
                        <li><code>&lt;ROFluxRed&gt;</code> - Runoff flux reduction</li>
                        <li><code>&lt;ErosMassRed&gt;</code> - Erosion mass reduction</li>
                        <li><code>&lt;ErosFluxRed&gt;</code> - Erosion flux reduction</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, setting up multi-parameter selection...');

        // Get all checkbox groups
        const nozzleCheckboxes = document.querySelectorAll('.nozzle-checkbox');
        const runoffCheckboxes = document.querySelectorAll('.runoff-checkbox');
        const bufferCheckboxes = document.querySelectorAll('.buffer-checkbox');

        // Hidden form fields for legacy compatibility
        const nozzleReductionField = document.getElementById('nozzle_reduction');
        const mitigationScenarioField = document.getElementById('mitigation_scenario');
        const bufferWidthField = document.getElementById('buffer_width');

        // Preview elements
        const combinationsPreview = document.getElementById('combinationsPreview');
        const combinationCount = document.getElementById('combinationCount');

        // Function to generate all parameter combinations
        function generateCombinations() {
            const selectedNozzles = Array.from(nozzleCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value));

            const selectedRunoffs = Array.from(runoffCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            const selectedBuffers = Array.from(bufferCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value));

            // If no parameters selected, show default message
            if (selectedNozzles.length === 0 && selectedRunoffs.length === 0 && selectedBuffers.length === 0) {
                combinationsPreview.innerHTML = '<p class="text-muted mb-0">Select parameters above to see the combinations that will be generated...</p>';
                combinationCount.textContent = '0';
                return [];
            }

            // Generate all combinations
            const combinations = [];
            const nozzleValues = selectedNozzles.length > 0 ? selectedNozzles : [0];
            const runoffValues = selectedRunoffs.length > 0 ? selectedRunoffs : [''];
            const bufferValues = selectedBuffers.length > 0 ? selectedBuffers : [0];

            for (const nozzle of nozzleValues) {
                for (const runoff of runoffValues) {
                    for (const buffer of bufferValues) {
                        const combination = {
                            nozzle: nozzle,
                            runoff: runoff,
                            buffer: buffer,
                            params: []
                        };

                        // Build parameter string
                        if (nozzle > 0) combination.params.push(`${nozzle}N`);
                        if (buffer > 0) combination.params.push(`${buffer}B`);
                        if (runoff === '10m') combination.params.push('10L&M');
                        if (runoff === '20m') combination.params.push('20L&M');

                        combinations.push(combination);
                    }
                }
            }

            // Update preview
            updateCombinationsPreview(combinations);
            return combinations;
        }

        // Function to update the combinations preview
        function updateCombinationsPreview(combinations) {
            if (combinations.length === 0) {
                combinationsPreview.innerHTML = '<p class="text-muted mb-0">Select parameters above to see the combinations that will be generated...</p>';
                combinationCount.textContent = '0';
                return;
            }

            const projectName = '{{ projects[0].project_name if projects else "PROJECT_NAME" }}';
            let previewHTML = '';

            combinations.forEach((combo, index) => {
                const paramString = combo.params.length > 0 ? '_' + combo.params.join('_') : '';
                const outputName = projectName + paramString;

                previewHTML += `
                    <div class="parameter-combination">
                        <div class="combination-preview">
                            <strong>${outputName}</strong>
                        </div>
                        <div class="small text-muted mt-1">
                            Nozzle: ${combo.nozzle}% | 
                            ${combo.runoff ? `Runoff: ${combo.runoff}` : 'No runoff'} | 
                            Buffer: ${combo.buffer}m
                        </div>
                    </div>
                `;
            });

            combinationsPreview.innerHTML = previewHTML;
            combinationCount.textContent = combinations.length;
        }

        // Add event listeners to all checkboxes
        function addCheckboxListeners() {
            const allCheckboxes = [...nozzleCheckboxes, ...runoffCheckboxes, ...bufferCheckboxes];

            allCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    generateCombinations();
                });
            });
        }

        // Function to prepare form data for submission
        function prepareFormData() {
            const combinations = generateCombinations();

            // Create hidden fields for each combination
            combinations.forEach((combo, index) => {
                // Create hidden inputs for this combination
                const nozzleInput = document.createElement('input');
                nozzleInput.type = 'hidden';
                nozzleInput.name = `combinations[${index}][nozzle]`;
                nozzleInput.value = combo.nozzle;

                const runoffInput = document.createElement('input');
                runoffInput.type = 'hidden';
                runoffInput.name = `combinations[${index}][runoff]`;
                runoffInput.value = combo.runoff;

                const bufferInput = document.createElement('input');
                bufferInput.type = 'hidden';
                bufferInput.name = `combinations[${index}][buffer]`;
                bufferInput.value = combo.buffer;

                // Add to form
                document.getElementById('parameterForm').appendChild(nozzleInput);
                document.getElementById('parameterForm').appendChild(runoffInput);
                document.getElementById('parameterForm').appendChild(bufferInput);
            });

            // Add total combinations count
            const countInput = document.createElement('input');
            countInput.type = 'hidden';
            countInput.name = 'total_combinations';
            countInput.value = combinations.length;
            document.getElementById('parameterForm').appendChild(countInput);
        }

        // Add form submission handler
        document.getElementById('parameterForm').addEventListener('submit', function (e) {
            const combinations = generateCombinations();

            if (combinations.length === 0) {
                e.preventDefault();
                alert('Please select at least one parameter combination.');
                return;
            }

            // Prepare form data
            prepareFormData();
        });

        // Initialize
        addCheckboxListeners();
        generateCombinations();

        console.log('Multi-parameter selection setup complete');
    });
</script>
{% endblock %}